Tokamak example
===============

Input grid
----------

To run these examples, you will need a grid file for a tokamak. 
These can be generated by [Hypnotoad](https://github.com/boutproject/hypnotoad). 

The BOUT.inp input files assume that this grid file is in the same
directory as this README, and is called `tokamak-grid.nc`

Plasma profiles
---------------

To run a simulation, the density and temperature profiles should be
set in the grid file. These profiles are used for:
- Initial conditions. By default the `Ne0`, `Te0` and `Ti0` profiles are used
  to add to the starting `Ne`, `Pe` and `Pi` fields. This can be disabled by
  setting `startprofiles` to `false` in the `BOUT.inp` file.
- Feedback control of the particle source, if `adapt_source_n` is `true`. This uses
  the difference between the electron density and the value in the grid file.
- Feedback control of the electron and ion power sources, if `adapt_source_n` is `true`.
  These use the difference between the electron/ion pressure and the grid file profiles
  to set the electron/ion input power.

To modify a grid file, specifying the separatrix temperature and density:

    $ ./setprofiles thegridfile.nc Tesep Nesep

where `Tesep` is in eV and `Nesep` is in m^-3. e.g

    $ ./setprofiles thegridfile.nc 100 1e19

This will modify in place `thegridfile.nc`, keeping the pressure gradient
unchanged. 

Curvature
---------

The magnetic curvature is used in calculating the drift
when diamagnetic current is enabled. To ensure that the flux-surface
average radial flux is zero when pressure is constant on a flux
surface, the quantity J * Curl(b/B) must be zero. If this is not the case,
then large spurious radial currents and flows can result. 

A python script is included, `adjust_curvature.py` which will modify
the radial component of the curvature such that J * Curl(b/B) sums to
zero over closed flux surfaces. Note that this doesn't currently ensure that
Div( Curl(b/B) ) is zero, as the poloidal component of Curl(b/B) is not
modified. To use the script

    $ ./adjust_curvature.py thegridfile.nc

This will modify `thegridfile.nc`.

Simulations
-----------

First run the transport case. This includes neutrals, cross-field
diffusion, but no currents or drifts.

    $ mpirun -np 16 ./hermes-2 -d 1-no-currents

This will run for approx. 30 minutes, for a simulation time of 1e5/wci,
sufficient to reach steady state.

Then turn on currents and diamagnetic drift. Copy the `BOUT.restart.*` files
from `1-no-currents` into `2-currents` and restart:

    $ cp 1-no-currents/BOUT.restart.* 2-currents/
    $ mpirun -np 16 ./hermes-2 -d 2-currents restart

Analysis
--------

There are some python scripts to make plots and perform analysis of the volume
integrated power sources, sinks and transfer terms. Most of these take two
arguments: The grid file, and the directory containing the data e.g.

    $ ./make2dplots.py tokamak-example.nc 1-no-currents


- `make2dplots.py` Make 2D (poloidal cross-section) plots of the density and
  temperature; radiation; and energy transfer
- `plot_target_profiles.py`  Plot density, temperature and heat flux along
  the inner and outer targets
- `volume_integrals.py`  Integrate the power sources, sinks, and transfer terms
  over the core and SOL regions of the grid.
